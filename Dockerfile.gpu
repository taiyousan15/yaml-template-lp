# Dockerfile.gpu (GPU版 - DeepSeek-OCR対応)
# NVIDIA GPU + CUDA 11.8+ が必要

FROM nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04 AS base

# 環境変数設定
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV CUDA_VISIBLE_DEVICES=0

# Node.js 20.x とPython 3.11をインストール
RUN apt-get update && apt-get install -y \
    curl \
    ca-certificates \
    gnupg \
    python3.11 \
    python3.11-venv \
    python3-pip \
    git \
    build-essential \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Python 3.11をデフォルトに設定
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1

WORKDIR /app

# Node.js依存関係のインストール
COPY package*.json ./
RUN npm ci --only=production

# Python依存関係のインストール（DeepSeek-OCR含む）
COPY python/requirements.txt ./python/
RUN pip3 install --no-cache-dir --upgrade pip setuptools wheel && \
    pip3 install --no-cache-dir \
    torch==2.6.0 --index-url https://download.pytorch.org/whl/cu118 && \
    pip3 install --no-cache-dir \
    transformers==4.46.3 \
    tokenizers==0.20.3 \
    einops \
    addict \
    easydict \
    Pillow==10.4.0 \
    PyYAML==6.0.2 \
    opencv-python-headless==4.10.0.84 \
    pytesseract==0.3.13 \
    scikit-image==0.24.0 \
    numpy==2.0.2 \
    boto3==1.35.32

# Flash Attention（ビルドに時間がかかる）
RUN pip3 install --no-cache-dir flash-attn==2.7.3 --no-build-isolation || \
    echo "Warning: flash-attn installation failed, continuing without it"

# アプリケーションコードをコピー
COPY . .

# Next.jsビルド
ENV NODE_ENV=production
RUN npm run build

# 実行ユーザーを非rootに設定
RUN useradd -m -u 1001 appuser && \
    chown -R appuser:appuser /app
USER appuser

# モデルキャッシュディレクトリ
RUN mkdir -p /app/.cache/huggingface
ENV HF_HOME=/app/.cache/huggingface
ENV TRANSFORMERS_CACHE=/app/.cache/huggingface

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000/api/health || exit 1

CMD ["npm", "start"]
