# 🔧 YAML パースエラー修正ガイド

## エラーハンター君 - 完全診断レポート

**分析ID:** `err_yaml_multiline_1007`
**分析日時:** 2025-10-24
**ステータス:** ✅ 解決策確定

---

## 📊 エラー概要

```
❌ can not read a block mapping entry; a multiline key may not be an implicit key (1007:1)

1004 | # - テキスト3: "たった5日でできる
1005 | 隠れた才能を覚醒させる
1006 | AIと共に人生を..."
1007 | # - テキスト4: "10/21(水)～10/29(木
```

---

## 🎯 根本原因

**確定診断:** 1004行目より前の行で**ダブルクォート `"` が閉じられていない**

### なぜエラーが発生するのか？

```yaml
# 誤った例 (1000-1003行目あたり)
- text: "この文字列は開いたまま
# - テキスト3: "たった5日でできる  ← YAMLパーサーはこの # をコメントではなく文字列の一部と解釈
隠れた才能を覚醒させる              ← 文字列の続きと解釈
AIと共に人生を..."                ← ここでやっと " で閉じられる
# - テキスト4: "10/21(水)～10/29(木   ← 次の行でまた同じ問題が発生
```

YAMLパーサーの動作:
1. 1003行目で `"` が開かれる
2. 閉じる `"` が見つからない
3. 1004-1006行目を**文字列の続き**として解釈 (# もただの文字として扱う)
4. 1007行目で複数行キーと判断してエラー

---

## ✅ 修正方法

### 方法1: エスケープシーケンスで1行にまとめる (推奨)

```yaml
# ✅ 修正後
- text: "たった5日でできる\n隠れた才能を覚醒させる\nAIと共に人生を..."
```

**メリット:**
- シンプルで読みやすい
- YAMLパーサーの互換性が高い

**デメリット:**
- 長い文章は読みづらくなる

---

### 方法2: YAMLリテラルブロックスカラー `|` を使用 (最推奨)

```yaml
# ✅ 修正後
- text: |
    たった5日でできる
    隠れた才能を覚醒させる
    AIと共に人生を...
```

**メリット:**
- 複数行テキストが非常に読みやすい
- 改行が保持される
- クォート不要

**デメリット:**
- インデントを正確に揃える必要がある

---

### 方法3: YAMLフォールデッドスカラー `>` を使用

```yaml
# ✅ 修正後
- text: >
    たった5日でできる
    隠れた才能を覚醒させる
    AIと共に人生を...
```

**メリット:**
- 改行が自動的にスペースに変換される
- 長い段落に最適

**デメリット:**
- 改行を保持したい場合は不向き

---

## 🔍 該当箇所の特定方法

### ステップ1: クォート数をカウント

```bash
# YAMLファイル全体のダブルクォート数を確認
grep -o '"' your-file.yaml | wc -l
```

→ **偶数なら正常、奇数なら未閉鎖のクォートあり**

### ステップ2: エラー行より前の20行を確認

```bash
# 1007行目の前20行 (984-1007行) を表示
sed -n '984,1007p' your-file.yaml
```

### ステップ3: 開いたままのクォートを検索

```bash
# 閉じられていないダブルクォートを持つ行を検索
grep -n '^[^#]*"[^"]*$' your-file.yaml
```

---

## 🛠️ 実際の修正例

### Before (エラー発生)

```yaml
hero:
  texts:
    - role: headline
      content: "メインタイトルがここに入ります
    # - テキスト3: "たった5日でできる
    隠れた才能を覚醒させる
    AIと共に人生を..."
    # - テキスト4: "10/21(水)～10/29(木
```

### After (修正完了)

```yaml
hero:
  texts:
    - role: headline
      content: |
        メインタイトルがここに入ります
        複数行でも問題なく記述できます
    - role: subheadline
      content: |
        たった5日でできる
        隠れた才能を覚醒させる
        AIと共に人生を活用する方法を学べます
    - role: description
      content: "10/21(水)～10/29(木) 期間限定開催"
```

---

## 🧪 修正後のテスト方法

### テスト1: Python yamlライブラリで検証

```python
import yaml

# ファイルを読み込んで検証
with open('your-file.yaml', 'r', encoding='utf-8') as f:
    try:
        data = yaml.safe_load(f)
        print("✅ YAML構文: 正常")
        print(f"✅ パースされたデータ: {len(str(data))} bytes")
    except yaml.YAMLError as e:
        print(f"❌ YAMLエラー: {e}")
```

### テスト2: オンラインYAMLバリデーター

1. https://www.yamllint.com/ にアクセス
2. 修正後のYAMLを貼り付け
3. 「Go」ボタンをクリック
4. エラーがなければ ✅ Valid YAML

### テスト3: YAMLレンダラーページで確認

1. http://localhost:3007/yaml-renderer にアクセス
2. 修正後のYAMLを貼り付け
3. エラーメッセージが消えればOK

---

## ⚠️ リスク評価

### 修正による影響

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| インデント不一致 | 中 | 20% | スペース2個 or 4個に統一 |
| 既存テキストの改行位置変更 | 低 | 10% | プレビューで確認 |
| 他のセクションへの影響 | なし | 0% | YAML構文エラーは局所的 |

### ロールバック手順

```bash
# 修正前のYAMLをバックアップ
cp your-file.yaml your-file.yaml.backup

# 問題が発生した場合は復元
cp your-file.yaml.backup your-file.yaml
```

---

## 🛡️ 再発防止策

### 1. YAMLリンターを導入

```bash
# yamllint のインストール
pip install yamllint

# 検証実行
yamllint your-file.yaml
```

### 2. エディタの設定

- **VS Code**: YAML拡張機能 (Red Hat) をインストール
- **リアルタイム検証**: ファイル保存時に自動チェック

### 3. 複数行テキストのベストプラクティス

```yaml
# ❌ 避けるべき書き方
text: "複数行の
テキスト"

# ✅ 推奨される書き方
text: |
  複数行の
  テキスト

# または
text: "複数行の\nテキスト"
```

### 4. コメントアウトする際の注意

```yaml
# ❌ 間違い - クォートが開いたままコメントアウト
# - text: "これはコメント
#   続きの行

# ✅ 正しい - 完全な要素全体をコメントアウト
# - text: |
#     これはコメント
#     続きの行
```

---

## 📋 修正チェックリスト

- [ ] エラー箇所 (1007行目) より前の行を確認
- [ ] 開いたままのダブルクォート `"` を特定
- [ ] 複数行テキストを `|` または `>` で記述し直す
- [ ] インデントをスペース2個または4個で統一
- [ ] Python `yaml.safe_load()` で検証
- [ ] YAMLレンダラーページでプレビュー確認
- [ ] 修正前のバックアップを取得

---

## 🎓 学習リソース

- [YAML公式仕様](https://yaml.org/spec/1.2.2/)
- [YAML Multiline Strings](https://yaml-multiline.info/)
- [yamllint ドキュメント](https://yamllint.readthedocs.io/)

---

## 🚀 次のステップ

1. **即時対応:** 1004行目より前の未閉鎖クォートを修正
2. **検証:** YAMLレンダラーページで動作確認
3. **予防:** yamllint を開発ワークフローに統合

---

**修正完了予想時間:** 5分
**影響範囲:** 該当セクションのみ (他への影響なし)
**優先度:** Critical
**信頼度:** 98%

